<%args>
$schema
$title => 'Genes'
$pub
@gene_list
@highlight_terms => ()
$curs_root_uri
$multi_organism_mode
$pathogen_host_mode
</%args>

<div id="curs-gene-list-edit" class="curs-box">
  <div class="curs-box-title">
<% $title %>
  </div>
  <div class="curs-box-body">

  <form name="gene-edit" method="get" action="<% $edit_path %>">
% if (scalar(@table_1_hashes) > 0 || scalar(@table_2_hashes) > 0) {
%   if (scalar(@table_1_hashes) > 0) {
%   if ($table_1_header) {
      <div class="curs-gene-list-edit-table-header"><% $table_1_header %></div>
%   }
  <& /curs/gene_list_edit_table.mhtml, col_names => \@col_names, gene_hashes => \@table_1_hashes &>
%   }

%   if (scalar(@table_2_hashes) > 0) {
%     if ($table_2_header) {
        <div class="curs-gene-list-edit-table-header"><% $table_2_header %></div>
%     }
  <& /curs/gene_list_edit_table.mhtml, col_names => \@col_names, gene_hashes => \@table_2_hashes &>
%   }

  <div class="submit">
    <input type="submit" class="btn btn-primary" name="continue" value="Continue"/>
  </div>
  <div class="submit">
    <input type="submit" class="btn btn-primary" name="submit" value="Remove selected"/>
  </div>
% } else {
  <div class="no-genes-message">
    [No genes]
  </div>
% }

<div class="upload-genes-link">
  <a href="<% $upload_path %>">Add more genes from <% $pub->uniquename() %> ...</a>
</div>
</form>
</div>
</div>

<%init>
use Canto::Curs;
use Canto::Track;
use Canto::Curs::GeneProxy;

my %highlight_terms = ();
@highlight_terms{@highlight_terms} = @highlight_terms;

sub _search_highlight
{
  my $highlight_terms = shift;
  my $identifier = shift;

  return '' if !defined $identifier;

  HTML::Mason::Escapes::basic_html_escape(\$identifier);

  if (exists $highlight_terms->{$identifier}) {
    return '<span class="curs-matched-search-term">' . $identifier . '</span>';
  } else {
    return $identifier;
  }
}

my @gene_hashes = map {
     my $gene = $_;
     my $gene_proxy =
       Canto::Curs::GeneProxy->new(config => $c->config(), cursdb_gene => $_);

     my $synonyms_string =
       join (',', map { _search_highlight(\%highlight_terms, $_) } $gene_proxy->synonyms());
     my $hash = {
       'Systematic identifier' => _search_highlight(\%highlight_terms, $gene_proxy->primary_identifier()),
       Name => _search_highlight(\%highlight_terms, $gene_proxy->primary_name()),
       Product => $gene_proxy->product(),
       Synonyms => $synonyms_string,
       gene_id => $gene_proxy->gene_id(),
     };
     if ($multi_organism_mode) {
       $hash->{Organism} = $gene_proxy->organism_details()->{full_name};
       if ($pathogen_host_mode) {
         $hash->{pathogen_or_host} = $gene_proxy->organism_details()->{pathogen_or_host};
       }
     }
     $hash
   } @gene_list;

my @table_1_hashes = ();
my $table_1_header = undef;
my @table_2_hashes = ();
my $table_2_header = undef;

if ($pathogen_host_mode){
  $table_1_header = 'Pathogen genes:';
  $table_2_header = 'Host genes:';
  map {
    if ($_->{pathogen_or_host} eq 'host') {
      push @table_2_hashes, $_;
    } else {
      push @table_1_hashes, $_;
    }
  } @gene_hashes;
} else {
  @table_1_hashes = @gene_hashes;
}

my @col_names = ("Systematic identifier", "Name", "Synonyms", "Product");

if ($multi_organism_mode) {
  push @col_names, "Organism";
}

my $upload_path = "$curs_root_uri/gene_upload";
my $edit_path = "$curs_root_uri/edit_genes";
</%init>
